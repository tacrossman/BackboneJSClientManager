<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BackboneJS Client List</title>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.2/bootstrap.min.js">
  <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
</head>
<body>


  <div class="container">
    <h1>Client List</h1>
    <hr />
    <div class="page"></div>
  </div>


  <script type="text/template" id="user-list-template">
  <a href="#/new" class="btn btn-primary">New User</a>
  <hr />
    <table class="table table-hover">
     <thread>
        <tr>
          <th>First Name</th>
          <th> Last name</th>
          <th>Age</th>
          <th></th>
        </tr>
      </thread>
      <tbody>
        <% _.each(users, function(user) { %>
          <tr>
            <td><%= user.get('firstname') %></td>
            <td><%= user.get('lastname') %></td>
            <td><%= user.get('age') %></td>
            <td><a href="#/edit/<%= user.id %>" class="btn">Edit</td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </script>

  <script type="text/template" id="edit-user-template">
    <form class="edit-user-form">
      <legend>Create User</legend>
      <label>First Name</label>
      <input type="text" name="firstname" />
      <label>Last Name</label>
      <input type="text" name="lastname" />
      <label>Age</label>
      <input type="text" name="age" />
      <hr />
      <button type="submit" class="btn">Create User</button>
  </script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.9/backbone-min.js"></script>

<script>

  $.ajaxPrefilter( function( options, originalOptions, jqXHR) {
    options.url = 'http://backbonejs-beginner.herokuapp.com' + options.url;
  });

  $.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
  };

  var Users = Backbone.Collection.extend({
    url: '/users'
  });

  var User = Backbone.Model.extend({
    urlRoot: '/users'
  });

  var UserList = Backbone.View.extend({
    el: '.page',
    render: function () {
      var that = this;
      var users =  new Users();
      users.fetch({
        success: function (users) {
          var template = _.template($('#user-list-template').html(), {users: users.models});
          that.$el.html(template);
        }
      });      
    }
  });

  var EditUser = Backbone.View.extend({
    el: '.page',
    render: function (options) {
          if(options.id){
            var user = new User({id: options.id})
          } else{
            var template = _.template($('#edit-user-template').html(), {});
            this.$el.html(template);
          }

    },
    events: {
      'submit .edit-user-form': 'saveUser'
    },
    saveUser: function(ev) {
      var userDetails = $(ev.currentTarget).serializeObject();
      var user = new User();
      user.save(userDetails, {
        success: function (user){
          router.navigate('', {trigger: true});
        }
      })
      return false;
    }
  });

  var Router = Backbone.Router.extend ({
    routes: {
      '' : 'home',
      'new' : 'editUser',
      'edit/:id' : 'editUser'
    }
  });

  var userList = new UserList();
  var editUser = new EditUser();

  var router = new Router();
  router.on('route:home', function() {
    userList.render();
  });
  router.on('route:editUser', function(id) {
      editUser.render({id: id});
  });

  Backbone.history.start();

</script>


</body>
</html> 
